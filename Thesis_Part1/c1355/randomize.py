import glob, os
import subprocess
import random
import csv

#Critical nodes extracted from the golden code.
parameter =  ['G1', 'G2', 'G3', 'G4', 'G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'G22', 'G23', 'G24', 'G25', 'G26', 'G27', 'G28', 'G29', 'G30', 'G31', 'G32', 'G33', 'G34', 'G35', 'G36', 'G37', 'G38', 'G39', 'G40', 'G41', 'G1324', 'G1325', 'G1326', 'G1327', 'G1328', 'G1329', 'G1330', 'G1331', 'G1332', 'G1333', 'G1334', 'G1335', 'G1336', 'G1337', 'G1338', 'G1339', 'G1340', 'G1341', 'G1342', 'G1343', 'G1344', 'G1345', 'G1346', 'G1347', 'G1348', 'G1349', 'G1350', 'G1351', 'G1352', 'G1353', 'G1354', 'G1355', 'd1', 'd2', 'd3', 'd4', 'd5', 'd6', 'd7', 'd8', 'd9', 'd10', 'd11', 'd12', 'd13', 'd14', 'd15', 'd16', 'd17', 'd18', 'd19', 'd20', 'd21', 'd22', 'd23', 'd24', 'd25', 'd26', 'd27', 'd28', 'd29', 'd30', 'd31', 'd32', 'd33', 'd34', 'd35', 'd36', 'd37', 'd38', 'd39', 'd40', 'd41', 'd1324', 'd1325', 'd1326', 'd1327', 'd1328', 'd1329', 'd1330', 'd1331', 'd1332', 'd1333', 'd1334', 'd1335', 'd1336', 'd1337', 'd1338', 'd1339', 'd1340', 'd1341', 'd1342', 'd1343', 'd1344', 'd1345', 'd1346', 'd1347', 'd1348', 'd1349', 'd1350', 'd1351', 'd1352', 'd1353', 'd1354', 'd1355', 'G242', 'G245', 'G248', 'G251', 'G254', 'G257', 'G260', 'G263', 'G266', 'G269', 'G272', 'G275', 'G278', 'G281', 'G284', 'G287', 'G290', 'G293', 'G296', 'G299', 'G302', 'G305', 'G308', 'G311', 'G314', 'G317', 'G320', 'G323', 'G326', 'G329', 'G332', 'G335', 'G338', 'G341', 'G344', 'G347', 'G350', 'G353', 'G356', 'G359', 'G362', 'G363', 'G364', 'G365', 'G366', 'G367', 'G368', 'G369', 'G370', 'G371', 'G372', 'G373', 'G374', 'G375', 'G376', 'G377', 'G378', 'G379', 'G380', 'G381', 'G382', 'G383', 'G384', 'G385', 'G386', 'G387', 'G388', 'G389', 'G390', 'G391', 'G392', 'G393', 'G394', 'G395', 'G396', 'G397', 'G398', 'G399', 'G400', 'G401', 'G402', 'G403', 'G404', 'G405', 'G406', 'G407', 'G408', 'G409', 'G410', 'G411', 'G412', 'G413', 'G414', 'G415', 'G416', 'G417', 'G418', 'G419', 'G420', 'G421', 'G422', 'G423', 'G424', 'G425', 'G426', 'G429', 'G432', 'G435', 'G438', 'G441', 'G444', 'G447', 'G450', 'G453', 'G456', 'G459', 'G462', 'G465', 'G468', 'G471', 'G474', 'G477', 'G480', 'G483', 'G486', 'G489', 'G492', 'G495', 'G498', 'G501', 'G504', 'G507', 'G510', 'G513', 'G516', 'G519', 'G522', 'G525', 'G528', 'G531', 'G534', 'G537', 'G540', 'G543', 'G546', 'G549', 'G552', 'G555', 'G558', 'G561', 'G564', 'G567', 'G570', 'G571', 'G572', 'G573', 'G574', 'G575', 'G576', 'G577', 'G578', 'G579', 'G580', 'G581', 'G582', 'G583', 'G584', 'G585', 'G586', 'G587', 'G588', 'G589', 'G590', 'G591', 'G592', 'G593', 'G594', 'G595', 'G596', 'G597', 'G598', 'G599', 'G600', 'G601', 'G602', 'G607', 'G612', 'G617', 'G622', 'G627', 'G632', 'G637', 'G642', 'G645', 'G648', 'G651', 'G654', 'G657', 'G660', 'G663', 'G666', 'G669', 'G672', 'G675', 'G678', 'G681', 'G684', 'G687', 'G690', 'G691', 'G692', 'G693', 'G694', 'G695', 'G696', 'G697', 'G698', 'G699', 'G700', 'G701', 'G702', 'G703', 'G704', 'G705', 'G706', 'G709', 'G712', 'G715', 'G718', 'G721', 'G724', 'G727', 'G730', 'G733', 'G736', 'G739', 'G742', 'G745', 'G748', 'G751', 'G754', 'G755', 'G756', 'G757', 'G758', 'G759', 'G760', 'G761', 'G762', 'G763', 'G764', 'G765', 'G766', 'G767', 'G768', 'G769', 'G770', 'G773', 'G776', 'G779', 'G782', 'G785', 'G788', 'G791', 'G794', 'G797', 'G800', 'G803', 'G806', 'G809', 'G812', 'G815', 'G818', 'G819', 'G820', 'G821', 'G822', 'G823', 'G824', 'G825', 'G826', 'G827', 'G828', 'G829', 'G830', 'G831', 'G832', 'G833', 'G834', 'G847', 'G860', 'G873', 'G886', 'G899', 'G912', 'G925', 'G938', 'G939', 'G940', 'G941', 'G942', 'G943', 'G944', 'G945', 'G946', 'G947', 'G948', 'G949', 'G950', 'G951', 'G952', 'G953', 'G954', 'G955', 'G956', 'G957', 'G958', 'G959', 'G960', 'G961', 'G962', 'G963', 'G964', 'G965', 'G966', 'G967', 'G968', 'G969', 'G970', 'G971', 'G972', 'G973', 'G974', 'G975', 'G976', 'G977', 'G978', 'G979', 'G980', 'G981', 'G982', 'G983', 'G984', 'G985', 'G986', 'G991', 'G996', 'G1001', 'G1006', 'G1011', 'G1016', 'G1021', 'G1026', 'G1031', 'G1036', 'G1039', 'G1042', 'G1045', 'G1048', 'G1051', 'G1054', 'G1057', 'G1060', 'G1063', 'G1066', 'G1069', 'G1072', 'G1075', 'G1078', 'G1081', 'G1084', 'G1087', 'G1090', 'G1093', 'G1096', 'G1099', 'G1102', 'G1105', 'G1108', 'G1111', 'G1114', 'G1117', 'G1120', 'G1123', 'G1126', 'G1129', 'G1132', 'G1135', 'G1138', 'G1141', 'G1144', 'G1147', 'G1150', 'G1153', 'G1156', 'G1159', 'G1162', 'G1165', 'G1168', 'G1171', 'G1174', 'G1177', 'G1180', 'G1183', 'G1186', 'G1189', 'G1192', 'G1195', 'G1198', 'G1201', 'G1204', 'G1207', 'G1210', 'G1213', 'G1216', 'G1219', 'G1222', 'G1225', 'G1228', 'G1229', 'G1230', 'G1231', 'G1232', 'G1233', 'G1234', 'G1235', 'G1236', 'G1237', 'G1238', 'G1239', 'G1240', 'G1241', 'G1242', 'G1243', 'G1244', 'G1245', 'G1246', 'G1247', 'G1248', 'G1249', 'G1250', 'G1251', 'G1252', 'G1253', 'G1254', 'G1255', 'G1256', 'G1257', 'G1258', 'G1259', 'G1260', 'G1261', 'G1262', 'G1263', 'G1264', 'G1265', 'G1266', 'G1267', 'G1268', 'G1269', 'G1270', 'G1271', 'G1272', 'G1273', 'G1274', 'G1275', 'G1276', 'G1277', 'G1278', 'G1279', 'G1280', 'G1281', 'G1282', 'G1283', 'G1284', 'G1285', 'G1286', 'G1287', 'G1288', 'G1289', 'G1290', 'G1291', 'G1292', 'G1293', 'G1294', 'G1295', 'G1296', 'G1297', 'G1298', 'G1299', 'G1300', 'G1301', 'G1302', 'G1303', 'G1304', 'G1305', 'G1306', 'G1307', 'G1308', 'G1309', 'G1310', 'G1311', 'G1312', 'G1313', 'G1314', 'G1315', 'G1316', 'G1317', 'G1318', 'G1319', 'G1320', 'G1321', 'G1322', 'G1323']
lookup = 'en = 0'
linenumber = []
rows = []
toAdd = ["Clk", "G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10", "G11", "G12", "G13", "G14", "G15", "G16", "G17", "G18", "G19", "G20", "G21", "G22", "G23", "G24", "G25", "G26", "G27", "G28", "G29", "G30", "G31", "G32", "G33", "G34", "G35", "G36", "G37", "G38", "G39", "G40", "G41", "en", "G1324", "G1325", "G1326", "G1327", "G1328", "G1329", "G1330", "G1331", "G1332", "G1333", "G1334", "G1335", "G1336", "G1337", "G1338", "G1339", "G1340", "G1341", "G1342", "G1343", "G1344", "G1345", "G1346", "G1347", "G1348", "G1349", "G1350", "G1351", "G1352", "G1353", "G1354", "G1355"]
# Generating a random number, to randomly select one of the parameters
randpara = random.randint(0, 659)
#print ("Random number = ",randpara)
para = parameter[randpara];
#print("Random Parameter = ", para);

# Generating a random number, to randomly select one of the clock cycle to inject fault
# After generating random number, print the index
#randrange ([start,] stop [,step])
randcycle = random.randrange(2, 999, 2)
randcycle  = randcycle + 0.8;
#print ("Random clock cycle = ",randcycle)
randomize = repr(randcycle) + "_" + para;
print(randomize)

for param in parameter:
    with open('fault{}.v'.format(randomize), "w") as f:
        with open('fault{}.v'.format(para), 'r') as h:
            for num, line in enumerate(h, 1):
                if lookup in line:
                    linenumber.append(num)

        change = "\t\t#" + repr(randcycle) + " " + "en = 1;\n"

        with open('fault{}.v'.format(para), 'r') as k:
            lines = k.readlines()

        with open('fault{}.v'.format(randomize), "w") as m:
            for i, line in enumerate(lines):
                if i == linenumber[1]-1:
                    m.write(change)
                m.write(line)

# creating csv file to store the output of this faulty file
for para in parameter:
    with open('fault{}.v'.format(randomize), "r") as f:
        cmd1 = 'iverilog -o fault' + randomize + " " + 'fault' + randomize + '.v'
        #print(cmd1)
        cmd2 = 'vvp fault' + randomize + " " + '> fault' + randomize + '.csv'
        os.system(cmd1)
        os.system(cmd2)

    with open('fault{}.csv'.format(randomize), "r") as infile:
        reader = list(csv.reader(infile))
        reader.insert(0, toAdd)

    with open('fault{}.csv'.format(randomize), "w", newline = '') as outfile:
        writer = csv.writer(outfile)
        for line in reader:
            writer.writerow(line)
